<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f4f7fa;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #efe5e5, #8f8f8f);
            color: var(--text-color);
            line-height: 1.6;
        }


        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .tab {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .tab button {
            background-color: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: var(--text-color);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab button:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }

        .tab button.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .tabcontent {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        form {
            margin-bottom: 20px;
        }

        input,
        select,
        button {
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3a7bc8;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: none;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .remove-btn,
        .edit-btn {
            cursor: pointer;
            margin-right: 5px;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .remove-btn {
            background-color: #ff4d4d;
            color: white;
        }

        .edit-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .remove-btn:hover,
        .edit-btn:hover {
            opacity: 0.8;
        }

        #expenseChart {
            max-width: 600px;
            margin: 20px auto;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #customCategoryInput {
            display: none;
        }

        .search-container {
            display: flex;
            margin-bottom: 20px;
        }

        .search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 14px;
        }

        .search-button,
        .reset-button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-button {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .reset-button {
            background-color: var(--secondary-color);
            color: white;
            border-radius: var(--border-radius);
            margin-left: 10px;
        }

        .search-button:hover,
        .reset-button:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Budget and Loan Tracker</h1>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Expenses')" id="defaultOpen">Expenses</button>
            <button class="tablinks" onclick="openTab(event, 'Loans')">Loans</button>
            <button class="tablinks" onclick="openTab(event, 'Payments')">Payments</button>
        </div>

        <div id="Expenses" class="tabcontent">
            <h2>Add Expense</h2>
            <form id="expenseForm">
                <input type="date" id="expenseDate" required>
                <input type="number" id="expenseAmount" placeholder="Amount" step="0.01" required>
                <input type="text" id="expenseDescription" placeholder="Description" required>
                <select id="expenseCategory" required>
                    <option value="">Select Category</option>
                    <option value="Food">Food</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Home">Home</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Debt">Debt</option>
                    <option value="Other">Other</option>
                    <option value="custom">Add Custom Category</option>
                </select>
                <input type="text" id="customCategoryInput" placeholder="Enter custom category" style="display:none;">
                <button type="submit">Add Expense</button>
            </form>
            <h2>Expense Summary</h2>
            <div class="search-container">
                <input type="text" id="expenseSearch" class="search-input"
                    placeholder="Search by date (YYYY-MM-DD) or category">
                <button onclick="searchExpenses()" class="search-button">Search</button>
                <button onclick="resetExpenseSearch()" class="reset-button">Reset</button>
            </div>
            <canvas id="expenseChart"></canvas>
            <table id="expenseTable"></table>
        </div>

        <div id="Loans" class="tabcontent">
            <h2>Add Loan</h2>
            <form id="loanForm">
                <input type="number" id="totalAmount" placeholder="Total Loan Amount" step="0.01" required>
                <input type="number" id="apr" placeholder="Annual Interest Rate (%)" step="0.01" required>
                <input type="number" id="term" placeholder="Loan Term (months, 0 for indefinite)" min="0" required>
                <input type="text" id="loanCategory" placeholder="Loan Category" required>
                <input type="number" id="monthlyPayment" placeholder="Monthly Payment" step="0.01" required>
                <button type="submit">Add Loan</button>
            </form>
            <h2>Loans Summary</h2>
            <table id="loansTable"></table>
        </div>

        <div id="Payments" class="tabcontent">
            <h2>Add Payment</h2>
            <form id="paymentForm">
                <select id="loanIndex" required></select>
                <input type="date" id="paymentDate" required>
                <input type="number" id="paymentAmount" placeholder="Payment Amount" step="0.01" required>
                <button type="submit" id="paymentSubmitButton">Add Payment</button>
            </form>
            <h2>Payments Summary</h2>
            <div class="search-container">
                <input type="text" id="paymentSearch" class="search-input"
                    placeholder="Search by date (YYYY-MM-DD) or loan category">
                <button onclick="searchPayments()" class="search-button">Search</button>
                <button onclick="resetPaymentSearch()" class="reset-button">Reset</button>
            </div>
            <table id="paymentsTable"></table>
        </div>
    </div>

    <script>

        function getRandomColor() {
            return '#' + Math.floor(Math.random() * 16777215).toString(16);
        }

        let categoryColors = {};

        function getCategoryColor(category) {
            if (!categoryColors[category]) {
                categoryColors[category] = getRandomColor();
            }
            return categoryColors[category];
        }

        let allPayments = [];
        let paymentsLoaded = false;
        let allLoans = []; // Make sure this is populated when loans are fetched
        // Global variables to store data
        function openTab(evt, tabName) {
            console.log('Opening tab:', tabName);
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // Only load payments data when Payments tab is clicked
            if (tabName === 'Payments') {
                console.log('Payments tab clicked');
                google.script.run.withSuccessHandler(updatePayments).getPayments();
            }
        }

        // Global variable to store expenses
        let allExpenses = [];

        // Make sure these functions are defined
        function fetchAllExpenses() {
            console.log('Fetching all expenses');
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received all expenses from server:', result);
                    if (result && Array.isArray(result)) {
                        updateExpenses(result);
                    } else {
                        console.error('Received invalid expense data from server');
                        alert('Error fetching expenses. Please try again.');
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error fetching expenses:', error);
                    alert('Error fetching expenses: ' + error.message);
                })
                .getExpenses();
        }
        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', fetchAllExpenses);

        // In the expense form submission event listener
        // Updated expense form submission handler
        document.getElementById('expenseForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var category = this.expenseCategory.value;
            if (category === 'custom') {
                category = this.customCategoryInput.value;
                if (category.trim() === '') {
                    alert('Please enter a custom category');
                    return;
                }
                google.script.run.withSuccessHandler(updateCategories).addCategory(category);
            }
            var newExpense = {
                date: this.expenseDate.value,
                amount: Number(this.expenseAmount.value),
                description: this.expenseDescription.value,
                category: category
            };
            console.log('Submitting new expense:', newExpense);

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received expense data from server after addition:', result);
                    if (result && Array.isArray(result)) {
                        allExpenses = result;
                        updateExpenses(allExpenses);
                    } else {
                        console.error('Received invalid expense data from server after addition');
                        alert('Error adding expense. Please try again.');
                        fetchAllExpenses();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error adding expense:', error);
                    alert('Error adding expense: ' + error.message);
                    fetchAllExpenses();
                })
                .addExpense(newExpense.date, newExpense.amount, newExpense.description, newExpense.category);

            this.reset();
            var customInput = document.getElementById('customCategoryInput');
            if (customInput) {
                customInput.style.display = 'none';
            }
        });



        document.getElementById('expenseCategory').addEventListener('change', function () {
            var customInput = document.getElementById('customCategoryInput');
            if (this.value === 'custom') {
                customInput.style.display = 'inline-block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
            }
        });


        document.getElementById('loanForm').addEventListener('submit', function (e) {
            e.preventDefault();
            google.script.run.withSuccessHandler(updateLoans).addLoan(
                Number(this.totalAmount.value),
                Number(this.apr.value),
                Number(this.term.value),
                this.loanCategory.value,
                Number(this.monthlyPayment.value)
            );
            this.reset();
        });

        function addPayment(e) {
            e.preventDefault();
            var loanIndex = document.getElementById('loanIndex').value;
            var paymentDate = document.getElementById('paymentDate').value;
            var paymentAmount = document.getElementById('paymentAmount').value;

            console.log('Submitting new payment:', { loanIndex, paymentDate, paymentAmount });

            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received result from addPayment:', result);
                    if (result.error) {
                        console.error('Error adding payment:', result.error);
                        alert('Error adding payment: ' + result.error);
                    } else {
                        updateLoans(result.loans);
                        updatePayments(result.payments, result.loans);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error in addPayment:', error);
                    alert('An error occurred while adding the payment. Please try again.');
                })
                .addPayment(Number(loanIndex), paymentDate, Number(paymentAmount));

            this.reset();
        }


        function fetchAllPayments() {
            console.log('Fetching all payments');
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received all payments from server:', result);
                    if (result && Array.isArray(result)) {
                        updatePayments(result);
                    } else {
                        console.error('Received invalid payment data from server');
                        alert('Error fetching payments. Please try again.');
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error fetching payments:', error);
                    alert('Error fetching payments: ' + error.message);
                })
                .getPayments();
        }
        // Function to set up the initial data
        function setupInitialData() {
            console.log('Setting up initial data');
            fetchAllExpenses();
            fetchAllLoans();
        }

        // Event listener for DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM fully loaded');
            // Trigger the click on the default tab
            document.getElementById("defaultOpen").click();

            // Load initial data
            setupInitialData();
        });


        function fetchAllLoans() {
            console.log('Fetching all loans');
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received all loans from server:', result);
                    if (result && Array.isArray(result)) {
                        updateLoans(result);
                    } else {
                        console.error('Received invalid loan data from server');
                        alert('Error fetching loans. Please try again.');
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error fetching loans:', error);
                    alert('Error fetching loans: ' + error.message);
                })
                .getLoans();
        }

        // Make sure to call this function when the page loads
        document.addEventListener('DOMContentLoaded', fetchAllPayments);
        document.getElementById('paymentForm').addEventListener('submit', addPayment);


        function updateCategories(categories) {
            var select = document.getElementById('expenseCategory');
            if (select) {
                var customOption = select.querySelector('option[value="custom"]');
                select.innerHTML = '';
                select.appendChild(new Option('Select Category', ''));
                categories.forEach(function (category) {
                    select.appendChild(new Option(category, category));
                });
                if (customOption) {
                    select.appendChild(customOption);
                } else {
                    select.appendChild(new Option('Add Custom Category', 'custom'));
                }
            }
        }


        function updateExpenses(expenses) {
            console.log('Updating expenses table with:', expenses);
            var table = document.getElementById('expenseTable');
            if (table) {
                var chartData = {};
                var total = 0;

                table.innerHTML = '<tr><th>Date</th><th>Amount</th><th>Description</th><th>Category</th><th>Action</th></tr>';

                if (expenses && expenses.length > 1) {
                    expenses.slice(1).forEach(function (expense, index) {
                        var row = table.insertRow(-1);
                        expense.forEach(function (cell, cellIndex) {
                            var cellElement = row.insertCell(cellIndex);
                            if (cellIndex === 0) {
                                // Format date as YYYY-MM-DD
                                cellElement.textContent = cell;
                            } else if (cellIndex === 1) {
                                cellElement.textContent = '$' + Number(cell).toFixed(2);
                            } else {
                                cellElement.textContent = cell;
                            }
                        });
                        var actionCell = row.insertCell(-1);
                        actionCell.innerHTML = '<span class="remove-btn" onclick="removeExpense(' + index + ')">Remove</span>';

                        if (expense[1] && !isNaN(expense[1])) {
                            total += parseFloat(expense[1]);
                            chartData[expense[3]] = (chartData[expense[3]] || 0) + parseFloat(expense[1]);
                        }
                    });

                    var totalRow = table.insertRow(-1);
                    totalRow.insertCell(0).textContent = 'Total';
                    totalRow.insertCell(1).textContent = '$' + total.toFixed(2);
                    totalRow.insertCell(2);
                    totalRow.insertCell(3);
                    totalRow.insertCell(4);

                    updateExpenseChart(chartData);
                } else {
                    table.innerHTML += '<tr><td colspan="5">No expenses found</td></tr>';
                    // Clear the chart if there are no expenses
                    updateExpenseChart({});
                }
            }
            console.log('Expense table updated');
        }

        function searchExpenses() {
            console.log('Searching expenses. Available data:', allExpenses);
            if (!allExpenses || allExpenses.length <= 1) {  // Check if there's only a header row or no data
                console.error('No expenses data available');
                alert('No expense data available for search. Please add some expenses first.');
                return;
            }
            var searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
            console.log('Search term:', searchTerm);
            var filteredExpenses = allExpenses.filter(function (expense, index) {
                if (index === 0) return true; // Keep the header row
                var date = expense[0].toLowerCase();
                var category = expense[3].toLowerCase();
                var description = expense[2].toLowerCase();
                console.log(`Checking expense: Date=${date}, Category=${category}, Description=${description}`);
                return date.includes(searchTerm) ||
                    category.includes(searchTerm) ||
                    description.includes(searchTerm);
            });
            console.log('Filtered expenses:', filteredExpenses);
            updateExpenses(filteredExpenses);
        }


        function resetExpenseSearch() {
            document.getElementById('expenseSearch').value = '';
            updateExpenses(window.allExpenses);
        }

        function updateLoans(loans) {
            allLoans = loans; // Store all loans for use in payment calculations

            var table = document.getElementById('loansTable');
            var loanSelect = document.getElementById('loanIndex');

            table.innerHTML = '<tr><th>Total Amount</th><th>APR</th><th>Term</th><th>Category</th><th>Monthly Payment</th><th>Total Interest</th><th>Remaining Balance</th><th>Action</th></tr>';
            loanSelect.innerHTML = '<option value="">Select Loan</option>';

            loans.forEach(function (loan, index) {
                if (index === 0) return; // Skip header row
                var row = table.insertRow(-1);
                loan.forEach(function (cell, cellIndex) {
                    var cellElement = row.insertCell(cellIndex);
                    switch (cellIndex) {
                        case 0: // Total Amount
                        case 4: // Monthly Payment
                        case 5: // Total Interest
                        case 6: // Remaining Balance
                            cellElement.textContent = '$' + Math.max(0, Number(cell)).toFixed(2);
                            break;
                        case 1: // APR
                            cellElement.textContent = Number(cell).toFixed(2) + '%';
                            break;
                        case 2: // Term
                            cellElement.textContent = cell === 'Indefinite' ? cell : cell + ' months';
                            break;
                        default:
                            cellElement.textContent = cell;
                    }
                });
                var actionCell = row.insertCell(-1);
                actionCell.innerHTML = '<span class="edit-btn" onclick="editLoan(' + (index - 1) + ')">Edit</span>' +
                    '<span class="remove-btn" onclick="removeLoan(' + (index - 1) + ')">Remove</span>';

                loanSelect.options.add(new Option('Loan ' + index + ' (' + loan[3] + ')', index - 1));
            });
        }


        function updatePayments(payments, allLoans) {
            console.log('Updating payments table with:', payments);
            console.log('All loans:', allLoans);
            var table = document.getElementById('paymentsTable');
            if (table && allLoans) {
                table.innerHTML = '<tr><th>Loan</th><th>Date</th><th>Amount</th><th>Principal</th><th>Interest</th><th>Remaining Balance</th><th>Payments Left</th><th>Action</th></tr>';

                if (payments && payments.length > 1) {
                    payments.forEach(function (payment, index) {
                        if (index === 0) return; // Skip header row
                        var row = table.insertRow(-1);
                        payment.forEach(function (cell, cellIndex) {
                            var cellElement = row.insertCell(cellIndex);
                            if (cellIndex === 0) {
                                // Find the corresponding loan and display its category
                                var loan = allLoans.find(l => l[0] === Number(cell) + 1);
                                cellElement.textContent = loan ? loan[3] : 'Unknown Loan';
                            } else if (cellIndex === 1) {
                                // Format date
                                var date = new Date(cell);
                                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                                cellElement.textContent = date.toLocaleDateString();
                            } else if (cellIndex === 6) {
                                // Payments Left
                                cellElement.textContent = cell !== null ? (cell === 0 ? 'Paid Off' : Math.round(cell)) : 'N/A';
                            } else {
                                // Format numbers as currency
                                cellElement.textContent = '$' + Number(cell).toFixed(2);
                            }
                        });

                        var actionCell = row.insertCell(-1);
                        actionCell.innerHTML = `
                    <span class="edit-btn" onclick="editPayment(${index - 1})">Edit</span>
                    <span class="remove-btn" onclick="removePayment(${index - 1})">Delete</span>
                `;
                    });
                } else {
                    table.innerHTML += '<tr><td colspan="8">No payments found</td></tr>';
                }
            } else {
                console.error('Table element not found or allLoans is undefined');
                if (!table) console.error('paymentsTable element not found in the DOM');
                if (!allLoans) console.error('allLoans is undefined');
            }
            console.log('Payment table updated');
        }


        function searchPayments() {
            console.log('Searching payments. Available data:', allPayments);
            if (!allPayments || allPayments.length === 0 || !allLoans || allLoans.length === 0) {
                console.error('No payments or loans data available');
                alert('No payment or loan data available for search. Please add some payments first.');
                return;
            }
            var searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            var filteredPayments = allPayments.filter(function (payment, index) {
                if (index === 0) return true; // Keep the header row
                var loan = allLoans.find(l => l[0] === Number(payment[0]) + 1);
                var loanCategory = loan ? loan[3].toLowerCase() : '';
                return payment[1].toLowerCase().includes(searchTerm) || // Date
                    loanCategory.includes(searchTerm);               // Loan category
            });
            console.log('Filtered payments:', filteredPayments);
            updatePayments(filteredPayments, allLoans);
        }

        function resetExpenseSearch() {
            document.getElementById('expenseSearch').value = '';
            updateExpenses(allExpenses);
        }

        function editPayment(index) {
            var payments = document.getElementById('paymentsTable').rows;
            var payment = payments[index + 1].cells; // +1 to skip header row

            // Find the loan index based on the loan category
            var loanCategory = payment[0].textContent;
            var loanIndex = allLoans.findIndex(loan => loan[3] === loanCategory) - 1; // -1 because allLoans includes header

            document.getElementById('loanIndex').value = loanIndex;

            // Parse the date correctly
            // Parse the date correctly
            var paymentDate = new Date(payment[1].textContent);
            paymentDate.setMinutes(paymentDate.getMinutes() + paymentDate.getTimezoneOffset());
            document.getElementById('paymentDate').value = paymentDate.toISOString().split('T')[0];

            document.getElementById('paymentAmount').value = payment[2].textContent.replace('$', '').trim();

            // Change the payment form submit button to update instead of add
            var paymentForm = document.getElementById('paymentForm');
            var originalOnSubmit = paymentForm.onsubmit; // Store the original onsubmit handler

            paymentForm.onsubmit = function (e) {
                e.preventDefault();
                google.script.run
                    .withSuccessHandler(function (result) {
                        console.log('Received result from updatePayment:', result);
                        if (result.error) {
                            console.error('Error updating payment:', result.error);
                            alert('Error updating payment: ' + result.error);
                        } else {
                            updateLoans(result.loans);
                            updatePayments(result.payments, result.loans);
                            // Reset the form after successful update
                            paymentForm.reset();
                            paymentForm.onsubmit = originalOnSubmit; // Restore the original onsubmit handler
                            document.getElementById('paymentSubmitButton').textContent = 'Add Payment';
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error in updatePayment:', error);
                        alert('An error occurred while updating the payment. Please try again.');
                    })
                    .updatePayment(
                        index,
                        Number(this.loanIndex.value),
                        this.paymentDate.value,
                        Number(this.paymentAmount.value)
                    );
            };
            document.getElementById('paymentSubmitButton').textContent = 'Update Payment';
        }

        let expenseChart = null; // Global variable to store the chart instance

        function updateExpenseChart(data) {
            var ctx = document.getElementById('expenseChart').getContext('2d');

            // Destroy the existing chart if it exists
            if (expenseChart) {
                expenseChart.destroy();
            }

            // Create a new chart
            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.keys(data).map(category => getCategoryColor(category))
                    }]
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: 'Expense Distribution'
                    }
                }
            });
        }

        // Make sure you have this function defined as well
        function removeExpense(index) {
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Expense removed, updating table');
                    if (result && Array.isArray(result)) {
                        updateExpenses(result);
                    } else {
                        console.error('Received invalid data after removing expense');
                        fetchAllExpenses();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error removing expense:', error);
                    alert('Error removing expense: ' + error.message);
                    fetchAllExpenses();
                })
                .removeExpense(index);
        }

        function editLoan(index) {
            var loans = document.getElementById('loansTable').rows;
            var loan = loans[index + 1].cells; // +1 to skip header row

            document.getElementById('totalAmount').value = loan[0].textContent.replace('$', '');
            document.getElementById('apr').value = loan[1].textContent.replace('%', '');
            document.getElementById('term').value = loan[2].textContent === 'Indefinite' ? 0 : loan[2].textContent;
            document.getElementById('loanCategory').value = loan[3].textContent;
            document.getElementById('monthlyPayment').value = loan[4].textContent.replace('$', '');

            // Change the loan form submit button to update instead of add
            var loanForm = document.getElementById('loanForm');
            loanForm.onsubmit = function (e) {
                e.preventDefault();
                google.script.run.withSuccessHandler(updateLoans).updateLoan(
                    index,
                    Number(this.totalAmount.value),
                    Number(this.apr.value),
                    Number(this.term.value),
                    this.loanCategory.value,
                    Number(this.monthlyPayment.value)
                );
                this.reset();
                this.onsubmit = null; // Reset the onsubmit handler
                document.getElementById('loanSubmitButton').textContent = 'Add Loan';
            };
            document.getElementById('loanSubmitButton').textContent = 'Update Loan';
        }

        function removeLoan(index) {
            google.script.run.withSuccessHandler(updateLoans).removeLoan(index);
        }

        function removePayment(index) {
            console.log('Removing payment at index:', index);
            if (confirm('Are you sure you want to delete this payment?')) {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.error) {
                            console.error('Error removing payment:', result.error);
                            alert('Error removing payment: ' + result.error);
                        } else {
                            updateLoans(result.loans);
                            updatePayments(result.payments, result.loans);
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error in removePayment:', error);
                        alert('An error occurred while removing the payment. Please try again.');
                    })
                    .removePayment(index);
            }
        }



        function loadInitialData() {
            console.log('Loading initial data...');
            google.script.run
                .withSuccessHandler(function (result) {
                    console.log('Received initial data from server:', result);
                    if (result.expenses) {
                        allExpenses = result.expenses;
                        console.log('Loaded expenses:', allExpenses);
                        updateExpenses(allExpenses);
                    } else {
                        console.warn('No expenses data received');
                    }
                    // ... (load other data like payments and loans)
                })
                .withFailureHandler(function (error) {
                    console.error('Error fetching initial data:', error);
                })
                .getInitialData();
        }

        function updateAll(data) {
            if (data && data.loans) {
                updateLoans(data.loans);
            }
            if (data && data.payments) {
                updatePayments(data.payments);
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM fully loaded. Initializing data...');
            loadInitialData();

            // Add event listener for search button
            document.getElementById('searchExpensesButton').addEventListener('click', searchExpenses);
        });

        // Add these event listeners to your search buttons
        document.getElementById('searchExpensesButton').addEventListener('click', searchExpenses);
        document.getElementById('resetExpenseSearchButton').addEventListener('click', resetExpenseSearch);
        document.getElementById('searchPaymentsButton').addEventListener('click', searchPayments);
        document.getElementById('resetPaymentSearchButton').addEventListener('click', resetPaymentSearch);

        // Initial data load
        google.script.run.withSuccessHandler(updateCategories).getCategories();
        google.script.run.withSuccessHandler(updateExpenses).getExpenses();
        google.script.run.withSuccessHandler(updateLoans).getLoans();
        google.script.run.withSuccessHandler(updatePayments).getPayments();
    </script>
</body>

</html>